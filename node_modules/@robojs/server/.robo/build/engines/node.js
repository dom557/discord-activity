import { createServerHandler } from "../core/handler.js";
import { logger } from "../core/logger.js";
import { Router } from "../core/router.js";
import { BaseEngine } from "./base.js";
import http from "node:http";
import { color, composeColors } from "robo.js";
export class NodeEngine extends BaseEngine {
    async init(options) {
        this._router = new Router();
        this._serverHandler = createServerHandler(this._router, options?.vite);
        this._server = http.createServer((req, res)=>this._serverHandler?.(req, res));
        this._server.on('error', (error)=>logger.error(`Server error:`, error));
        this._server.on('upgrade', (req, socket, head)=>{
            const handler = this._websocketHandlers[req.url ?? ''];
            if (handler) {
                handler(req, socket, head);
                return;
            }
            const defaultHandler = this._websocketHandlers['default'];
            if (defaultHandler) {
                defaultHandler(req, socket, head);
            } else {
                logger.warn(`No WebSocket handler found for`, req.url);
            }
        });
    }
    getHttpServer() {
        return this._server;
    }
    isRunning() {
        return this._isRunning;
    }
    registerRoute(path, handler) {
        this._router.addRoute({
            handler,
            path
        });
    }
    registerWebsocket(path, handler) {
        this._websocketHandlers[path] = handler;
    }
    setupVite(vite) {
        this._vite = vite;
        this._serverHandler = createServerHandler(this._router, vite);
    }
    async start(options) {
        const { port  } = options;
        return new Promise((resolve)=>{
            if (this._isRunning) {
                logger.warn('Server is already up and running. No action taken.');
                resolve();
                return;
            }
            // Start server
            this._isRunning = true;
            this._server.listen(port, ()=>{
                logger.ready(`Server is live at ${composeColors(color.bold, color.blue)(`http://localhost:${port}`)}`);
                resolve();
            });
        });
    }
    async stop() {
        const serverPromise = new Promise((resolve)=>{
            if (!this._server) {
                logger.debug(`Server isn't running. Nothing to stop here.`);
                resolve();
                return;
            }
            this._server.close((err)=>{
                if (err) {
                    logger.error(`Error stopping the server: ${err}`);
                    return;
                }
                this._isRunning = false;
                logger.debug('Server has been stopped successfully.');
                resolve();
            });
        });
        const vitePromise = this._vite?.close();
        await Promise.allSettled([
            serverPromise,
            vitePromise
        ]);
    }
    constructor(...args){
        super(...args);
        this._isRunning = false;
        this._router = null;
        this._server = null;
        this._vite = null;
        this._websocketHandlers = {};
        this._serverHandler = null;
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3JvYm8uanMvcm9iby5qcy9wYWNrYWdlcy9wbHVnaW4tYXBpL3NyYy9lbmdpbmVzL25vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmVySGFuZGxlciwgY3JlYXRlU2VydmVySGFuZGxlciB9IGZyb20gJy4uL2NvcmUvaGFuZGxlci5qcydcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2VyLmpzJ1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnLi4vY29yZS9yb3V0ZXIuanMnXG5pbXBvcnQgeyBCYXNlRW5naW5lIH0gZnJvbSAnLi4vZW5naW5lcy9iYXNlLmpzJ1xuaW1wb3J0IGh0dHAgZnJvbSAnbm9kZTpodHRwJ1xuaW1wb3J0IHsgY29sb3IsIGNvbXBvc2VDb2xvcnMgfSBmcm9tICdyb2JvLmpzJ1xuaW1wb3J0IHR5cGUgeyBSb3V0ZUhhbmRsZXIsIFdlYlNvY2tldEhhbmRsZXIgfSBmcm9tICcuLi9jb3JlL3R5cGVzLmpzJ1xuaW1wb3J0IHR5cGUgeyBJbml0T3B0aW9ucywgU3RhcnRPcHRpb25zIH0gZnJvbSAnLi4vZW5naW5lcy9iYXNlLmpzJ1xuaW1wb3J0IHR5cGUgeyBWaXRlRGV2U2VydmVyIH0gZnJvbSAndml0ZSdcblxuZXhwb3J0IGNsYXNzIE5vZGVFbmdpbmUgZXh0ZW5kcyBCYXNlRW5naW5lIHtcblx0cHJpdmF0ZSBfaXNSdW5uaW5nID0gZmFsc2Vcblx0cHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIgfCBudWxsID0gbnVsbFxuXHRwcml2YXRlIF9zZXJ2ZXI6IGh0dHAuU2VydmVyIHwgbnVsbCA9IG51bGxcblx0cHJpdmF0ZSBfdml0ZTogVml0ZURldlNlcnZlciB8IG51bGwgPSBudWxsXG5cdHByaXZhdGUgX3dlYnNvY2tldEhhbmRsZXJzOiBSZWNvcmQ8c3RyaW5nLCBXZWJTb2NrZXRIYW5kbGVyPiA9IHt9XG5cdHByb3RlY3RlZCBfc2VydmVySGFuZGxlcjogU2VydmVySGFuZGxlciB8IG51bGwgPSBudWxsXG5cblx0cHVibGljIGFzeW5jIGluaXQob3B0aW9uczogSW5pdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0aGlzLl9yb3V0ZXIgPSBuZXcgUm91dGVyKClcblx0XHR0aGlzLl9zZXJ2ZXJIYW5kbGVyID0gY3JlYXRlU2VydmVySGFuZGxlcih0aGlzLl9yb3V0ZXIsIG9wdGlvbnM/LnZpdGUpXG5cdFx0dGhpcy5fc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKHJlcSwgcmVzKSA9PiB0aGlzLl9zZXJ2ZXJIYW5kbGVyPy4ocmVxLCByZXMpKVxuXG5cdFx0dGhpcy5fc2VydmVyLm9uKCdlcnJvcicsIChlcnJvcjogRXJyb3IpID0+IGxvZ2dlci5lcnJvcihgU2VydmVyIGVycm9yOmAsIGVycm9yKSlcblx0XHR0aGlzLl9zZXJ2ZXIub24oJ3VwZ3JhZGUnLCAocmVxLCBzb2NrZXQsIGhlYWQpID0+IHtcblx0XHRcdGNvbnN0IGhhbmRsZXIgPSB0aGlzLl93ZWJzb2NrZXRIYW5kbGVyc1tyZXEudXJsID8/ICcnXVxuXG5cdFx0XHRpZiAoaGFuZGxlcikge1xuXHRcdFx0XHRoYW5kbGVyKHJlcSwgc29ja2V0LCBoZWFkKVxuXHRcdFx0XHRyZXR1cm5cblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZGVmYXVsdEhhbmRsZXIgPSB0aGlzLl93ZWJzb2NrZXRIYW5kbGVyc1snZGVmYXVsdCddXG5cdFx0XHRpZiAoZGVmYXVsdEhhbmRsZXIpIHtcblx0XHRcdFx0ZGVmYXVsdEhhbmRsZXIocmVxLCBzb2NrZXQsIGhlYWQpXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsb2dnZXIud2FybihgTm8gV2ViU29ja2V0IGhhbmRsZXIgZm91bmQgZm9yYCwgcmVxLnVybClcblx0XHRcdH1cblx0XHR9KVxuXHR9XG5cblx0cHVibGljIGdldEh0dHBTZXJ2ZXIoKSB7XG5cdFx0cmV0dXJuIHRoaXMuX3NlcnZlclxuXHR9XG5cblx0cHVibGljIGlzUnVubmluZygpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5faXNSdW5uaW5nXG5cdH1cblxuXHRwdWJsaWMgcmVnaXN0ZXJSb3V0ZShwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IFJvdXRlSGFuZGxlcikge1xuXHRcdHRoaXMuX3JvdXRlci5hZGRSb3V0ZSh7IGhhbmRsZXIsIHBhdGggfSlcblx0fVxuXG5cdHB1YmxpYyByZWdpc3RlcldlYnNvY2tldChwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IFdlYlNvY2tldEhhbmRsZXIpIHtcblx0XHR0aGlzLl93ZWJzb2NrZXRIYW5kbGVyc1twYXRoXSA9IGhhbmRsZXJcblx0fVxuXG5cdHB1YmxpYyBzZXR1cFZpdGUodml0ZTogVml0ZURldlNlcnZlcikge1xuXHRcdHRoaXMuX3ZpdGUgPSB2aXRlXG5cdFx0dGhpcy5fc2VydmVySGFuZGxlciA9IGNyZWF0ZVNlcnZlckhhbmRsZXIodGhpcy5fcm91dGVyLCB2aXRlKVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHN0YXJ0KG9wdGlvbnM6IFN0YXJ0T3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHsgcG9ydCB9ID0gb3B0aW9uc1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG5cdFx0XHRpZiAodGhpcy5faXNSdW5uaW5nKSB7XG5cdFx0XHRcdGxvZ2dlci53YXJuKCdTZXJ2ZXIgaXMgYWxyZWFkeSB1cCBhbmQgcnVubmluZy4gTm8gYWN0aW9uIHRha2VuLicpXG5cdFx0XHRcdHJlc29sdmUoKVxuXHRcdFx0XHRyZXR1cm5cblx0XHRcdH1cblxuXHRcdFx0Ly8gU3RhcnQgc2VydmVyXG5cdFx0XHR0aGlzLl9pc1J1bm5pbmcgPSB0cnVlXG5cdFx0XHR0aGlzLl9zZXJ2ZXIubGlzdGVuKHBvcnQsICgpID0+IHtcblx0XHRcdFx0bG9nZ2VyLnJlYWR5KGBTZXJ2ZXIgaXMgbGl2ZSBhdCAke2NvbXBvc2VDb2xvcnMoY29sb3IuYm9sZCwgY29sb3IuYmx1ZSkoYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWApfWApXG5cdFx0XHRcdHJlc29sdmUoKVxuXHRcdFx0fSlcblx0XHR9KVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHN0b3AoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3Qgc2VydmVyUHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG5cdFx0XHRpZiAoIXRoaXMuX3NlcnZlcikge1xuXHRcdFx0XHRsb2dnZXIuZGVidWcoYFNlcnZlciBpc24ndCBydW5uaW5nLiBOb3RoaW5nIHRvIHN0b3AgaGVyZS5gKVxuXHRcdFx0XHRyZXNvbHZlKClcblx0XHRcdFx0cmV0dXJuXG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuX3NlcnZlci5jbG9zZSgoZXJyKSA9PiB7XG5cdFx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIHN0b3BwaW5nIHRoZSBzZXJ2ZXI6ICR7ZXJyfWApXG5cdFx0XHRcdFx0cmV0dXJuXG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLl9pc1J1bm5pbmcgPSBmYWxzZVxuXHRcdFx0XHRsb2dnZXIuZGVidWcoJ1NlcnZlciBoYXMgYmVlbiBzdG9wcGVkIHN1Y2Nlc3NmdWxseS4nKVxuXHRcdFx0XHRyZXNvbHZlKClcblx0XHRcdH0pXG5cdFx0fSlcblx0XHRjb25zdCB2aXRlUHJvbWlzZSA9IHRoaXMuX3ZpdGU/LmNsb3NlKClcblxuXHRcdGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbc2VydmVyUHJvbWlzZSwgdml0ZVByb21pc2VdKVxuXHR9XG59XG4iXSwibmFtZXMiOlsiY3JlYXRlU2VydmVySGFuZGxlciIsImxvZ2dlciIsIlJvdXRlciIsIkJhc2VFbmdpbmUiLCJodHRwIiwiY29sb3IiLCJjb21wb3NlQ29sb3JzIiwiTm9kZUVuZ2luZSIsImluaXQiLCJvcHRpb25zIiwiX3JvdXRlciIsIl9zZXJ2ZXJIYW5kbGVyIiwidml0ZSIsIl9zZXJ2ZXIiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJyZXMiLCJvbiIsImVycm9yIiwic29ja2V0IiwiaGVhZCIsImhhbmRsZXIiLCJfd2Vic29ja2V0SGFuZGxlcnMiLCJ1cmwiLCJkZWZhdWx0SGFuZGxlciIsIndhcm4iLCJnZXRIdHRwU2VydmVyIiwiaXNSdW5uaW5nIiwiX2lzUnVubmluZyIsInJlZ2lzdGVyUm91dGUiLCJwYXRoIiwiYWRkUm91dGUiLCJyZWdpc3RlcldlYnNvY2tldCIsInNldHVwVml0ZSIsIl92aXRlIiwic3RhcnQiLCJwb3J0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJsaXN0ZW4iLCJyZWFkeSIsImJvbGQiLCJibHVlIiwic3RvcCIsInNlcnZlclByb21pc2UiLCJkZWJ1ZyIsImNsb3NlIiwiZXJyIiwidml0ZVByb21pc2UiLCJhbGxTZXR0bGVkIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUF3QkEsbUJBQW1CLFFBQVEscUJBQW9CO0FBQ3ZFLFNBQVNDLE1BQU0sUUFBUSxvQkFBbUI7QUFDMUMsU0FBU0MsTUFBTSxRQUFRLG9CQUFtQjtBQUMxQyxTQUFTQyxVQUFVLFFBQVEsWUFBb0I7QUFDL0MsT0FBT0MsVUFBVSxZQUFXO0FBQzVCLFNBQVNDLEtBQUssRUFBRUMsYUFBYSxRQUFRLFVBQVM7QUFLOUMsT0FBTyxNQUFNQyxtQkFBbUJKO0lBUS9CLE1BQWFLLEtBQUtDLE9BQW9CLEVBQWlCO1FBQ3RELElBQUksQ0FBQ0MsT0FBTyxHQUFHLElBQUlSO1FBQ25CLElBQUksQ0FBQ1MsY0FBYyxHQUFHWCxvQkFBb0IsSUFBSSxDQUFDVSxPQUFPLEVBQUVELFNBQVNHO1FBQ2pFLElBQUksQ0FBQ0MsT0FBTyxHQUFHVCxLQUFLVSxZQUFZLENBQUMsQ0FBQ0MsS0FBS0MsTUFBUSxJQUFJLENBQUNMLGNBQWMsR0FBR0ksS0FBS0M7UUFFMUUsSUFBSSxDQUFDSCxPQUFPLENBQUNJLEVBQUUsQ0FBQyxTQUFTLENBQUNDLFFBQWlCakIsT0FBT2lCLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxFQUFFQTtRQUN6RSxJQUFJLENBQUNMLE9BQU8sQ0FBQ0ksRUFBRSxD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