import { RoboRequest, applyParams } from "./robo-request.js";
import { RoboResponse } from "./robo-response.js";
import { logger } from "./logger.js";
import { pluginOptions } from "../events/_start.js";
import { mimeDb } from "./mime.js";
import { createReadStream } from "node:fs";
import { readdir, stat } from "node:fs/promises";
import path from "node:path";
import { pipeline } from "node:stream/promises";
import url from "node:url";
import { color } from "robo.js";
const PublicPath = path.join(process.cwd(), 'public');
const PublicBuildPath = path.join(process.cwd(), '.robo', 'public');
export function createServerHandler(router, vite) {
    return async (req, res)=>{
        const parsedUrl = url.parse(req.url, true);
        if (pluginOptions.cors) {
            // CORS Headers (to allow any origin, any method, and any header)
            res.setHeader('Access-Control-Allow-Origin', '*');
            res.setHeader('Access-Control-Allow-Methods', '*');
            res.setHeader('Access-Control-Allow-Headers', '*');
            // Preflight request. Reply successfully:
            if (req.method === 'OPTIONS') {
                res.writeHead(200);
                res.end();
                return;
            }
        }
        // Prepare request and reply wrappers for easier usage
        const requestWrapper = await RoboRequest.from(req);
        const replyWrapper = {
            raw: res,
            hasSent: false,
            code: function(statusCode) {
                this.raw.statusCode = statusCode;
                return this;
            },
            json: function(data) {
                this.raw.setHeader('Content-Type', 'application/json');
                this.raw.end(JSON.stringify(data));
                this.hasSent = true;
                return this;
            },
            send: function(data) {
                if (data instanceof Response) {
                    if (data.status >= 400) {
                        logger.error(data);
                    }
                    data.headers.forEach(([key, value])=>{
                        this.raw.setHeader(key, value);
                    });
                    this.raw.statusCode = data.status;
                    data.text().then((text)=>{
                        this.raw.end(text);
                    });
                } else {
                    this.raw.end(data);
                }
                this.hasSent = true;
                return this;
            },
            header: function(name, value) {
                this.raw.setHeader(name, value);
                return this;
            }
        };
        // Find matching route and execute handler
        logger.debug(color.bold(req.method), req.url);
        const route = router.find(parsedUrl.pathname);
        if (route) {
            applyParams(requestWrapper, route.params);
        }
        // If Vite is available, forward the request to Vite
        if (!route?.handler && vite) {
            logger.debug(`Forwarding to Vite:`, req.url);
            vite.middlewares(req, res);
            return;
        }
        // If route missing, check if we can return something from the public folder
        if (!route?.handler) {
            try {
                const callback = async (filePath, mimeType)=>{
                    res.setHeader('Content-Type', mimeType);
                    res.setHeader('X-Content-Type-Options', 'nosniff');
                    res.writeHead(200);
                    await pipeline(createReadStream(filePath), res);
                };
                if (await handlePublicFile(parsedUrl, callback)) {
                    return;
                }
            } catch (error) {
                if (error instanceof Response) {
                    replyWrapper.send(error);
                } else {
                    logger.error(error);
                }
            }
        }
        if (!route?.handler) {
            replyWrapper.code(404).json('API Route not found.');
            return;
        }
        try {
            const result = await route.handler(requestWrapper, replyWrapper);
            if (!replyWrapper.hasSent && result instanceof Response) {
                replyWrapper.send(result);
            } else if (!replyWrapper.hasSent && result) {
                replyWrapper.code(200).json(result);
            }
        } catch (error) {
            if (error instanceof Response) {
                replyWrapper.send(error);
            } else if (error instanceof Error) {
                logger.error(error);
                replyWrapper.code(500).json(error.message ?? 'Server encountered an error.');
            } else {
                logger.error(error);
                replyWrapper.code(500).send('Server encountered an error.');
            }
        }
    };
}
export async function handlePublicFile(parsedUrl, callback) {
    // Determine which public folder to use (production or development)
    const publicPath = process.env.NODE_ENV === 'production' ? PublicBuildPath : PublicPath;
    const filePath = decodeURI(path.join(publicPath, parsedUrl.pathname));
    // Check if the requested path is within the public folder to guard against directory traversal
    if (!filePath.startsWith(publicPath)) {
        logger.warn(`Requested path is outside the public folder. Denying access...`);
        throw RoboResponse.json({
            message: 'Access Denied'
        }, {
            status: 403
        });
    }
    // See if the file exists
    try {
        const stats = await stat(filePath);
        if (stats.isFile()) {
            logger.debug(`Serving public file: ${filePath}`);
            const ext = path.extname(filePath).slice(1);
            const mimeType = mimeDb[ext] ?? 'application/octet-stream';
            await callback(filePath, mimeType);
            return true;
        } else if (stats.isDirectory()) {
            // Look for an index file in the directory
            const files = await readdir(filePath);
            const indexExtensions = [
                'html',
                'htm',
                'php',
                'js',
                'json'
            ];
            const indexFile = files.find((file)=>{
                const extension = path.extname(file).slice(1);
                return indexExtensions.includes(extension) && file.startsWith('index.');
            });
            if (indexFile) {
                const indexFilePath = path.join(filePath, indexFile);
                const ext = path.extname(indexFilePath).slice(1);
                const mimeType = mimeDb[ext] ?? 'application/octet-stream';
                logger.debug('Serving public index file:', indexFilePath);
                await callback(indexFilePath, mimeType);
                return true;
            }
        }
    } catch (error) {
        // Ignore ENOENT errors (file not found)
        if (error.code !== 'ENOENT') {
            throw error;
        }
    }
    return false;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3JvYm8uanMvcm9iby5qcy9wYWNrYWdlcy9wbHVnaW4tYXBpL3NyYy9jb3JlL2hhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm9ib1JlcXVlc3QsIGFwcGx5UGFyYW1zIH0gZnJvbSAnLi9yb2JvLXJlcXVlc3QuanMnXG5pbXBvcnQgeyBSb2JvUmVzcG9uc2UgfSBmcm9tICcuL3JvYm8tcmVzcG9uc2UuanMnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlci5qcydcbmltcG9ydCB7IHBsdWdpbk9wdGlvbnMgfSBmcm9tICcuLi9ldmVudHMvX3N0YXJ0LmpzJ1xuaW1wb3J0IHsgbWltZURiIH0gZnJvbSAnLi9taW1lLmpzJ1xuaW1wb3J0IHsgY3JlYXRlUmVhZFN0cmVhbSB9IGZyb20gJ25vZGU6ZnMnXG5pbXBvcnQgeyByZWFkZGlyLCBzdGF0IH0gZnJvbSAnbm9kZTpmcy9wcm9taXNlcydcbmltcG9ydCB7IEluY29taW5nTWVzc2FnZSwgU2VydmVyUmVzcG9uc2UgfSBmcm9tICdub2RlOmh0dHAnXG5pbXBvcnQgcGF0aCBmcm9tICdub2RlOnBhdGgnXG5pbXBvcnQgeyBwaXBlbGluZSB9IGZyb20gJ25vZGU6c3RyZWFtL3Byb21pc2VzJ1xuaW1wb3J0IHVybCBmcm9tICdub2RlOnVybCdcbmltcG9ydCB7IGNvbG9yIH0gZnJvbSAncm9iby5qcydcbmltcG9ydCB0eXBlIHsgUm91dGVyIH0gZnJvbSAnLi9yb3V0ZXIuanMnXG5pbXBvcnQgdHlwZSB7IFJvYm9SZXBseSB9IGZyb20gJy4vdHlwZXMuanMnXG5pbXBvcnQgdHlwZSB7IFVybFdpdGhQYXJzZWRRdWVyeSB9IGZyb20gJ25vZGU6dXJsJ1xuaW1wb3J0IHR5cGUgeyBWaXRlRGV2U2VydmVyIH0gZnJvbSAndml0ZSdcblxuY29uc3QgUHVibGljUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAncHVibGljJylcbmNvbnN0IFB1YmxpY0J1aWxkUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnLnJvYm8nLCAncHVibGljJylcblxuZXhwb3J0IHR5cGUgU2VydmVySGFuZGxlciA9IChyZXE6IEluY29taW5nTWVzc2FnZSwgcmVzOiBTZXJ2ZXJSZXNwb25zZTxJbmNvbWluZ01lc3NhZ2U+KSA9PiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2VydmVySGFuZGxlcihyb3V0ZXI6IFJvdXRlciwgdml0ZT86IFZpdGVEZXZTZXJ2ZXIpOiBTZXJ2ZXJIYW5kbGVyIHtcblx0cmV0dXJuIGFzeW5jIChyZXE6IEluY29taW5nTWVzc2FnZSwgcmVzOiBTZXJ2ZXJSZXNwb25zZTxJbmNvbWluZ01lc3NhZ2U+KSA9PiB7XG5cdFx0Y29uc3QgcGFyc2VkVXJsID0gdXJsLnBhcnNlKHJlcS51cmwsIHRydWUpXG5cblx0XHRpZiAocGx1Z2luT3B0aW9ucy5jb3JzKSB7XG5cdFx0XHQvLyBDT1JTIEhlYWRlcnMgKHRvIGFsbG93IGFueSBvcmlnaW4sIGFueSBtZXRob2QsIGFuZCBhbnkgaGVhZGVyKVxuXHRcdFx0cmVzLnNldEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKVxuXHRcdFx0cmVzLnNldEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcycsICcqJylcblx0XHRcdHJlcy5zZXRIZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnKicpXG5cblx0XHRcdC8vIFByZWZsaWdodCByZXF1ZXN0LiBSZXBseSBzdWNjZXNzZnVsbHk6XG5cdFx0XHRpZiAocmVxLm1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG5cdFx0XHRcdHJlcy53cml0ZUhlYWQoMjAwKVxuXHRcdFx0XHRyZXMuZW5kKClcblx0XHRcdFx0cmV0dXJuXG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Ly8gUHJlcGFyZSByZXF1ZXN0IGFuZCByZXBseSB3cmFwcGVycyBmb3IgZWFzaWVyIHVzYWdlXG5cdFx0Y29uc3QgcmVxdWVzdFdyYXBwZXIgPSBhd2FpdCBSb2JvUmVxdWVzdC5mcm9tKHJlcSlcblxuXHRcdGNvbnN0IHJlcGx5V3JhcHBlcjogUm9ib1JlcGx5ID0ge1xuXHRcdFx0cmF3OiByZXMsXG5cdFx0XHRoYXNTZW50OiBmYWxzZSxcblx0XHRcdGNvZGU6IGZ1bmN0aW9uIChzdGF0dXNDb2RlOiBudW1iZXIpIHtcblx0XHRcdFx0dGhpcy5yYXcuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGVcblx0XHRcdFx0cmV0dXJuIHRoaXNcblx0XHRcdH0sXG5cdFx0XHRqc29uOiBmdW5jdGlvbiAoZGF0YTogdW5rbm93bikge1xuXHRcdFx0XHR0aGlzLnJhdy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcblx0XHRcdFx0dGhpcy5yYXcuZW5kKEpTT04uc3RyaW5naWZ5KGRhdGEpKVxuXHRcdFx0XHR0aGlzLmhhc1NlbnQgPSB0cnVlXG5cdFx0XHRcdHJldHVybiB0aGlzXG5cdFx0XHR9LFxuXHRcdFx0c2VuZDogZnVuY3Rpb24gKGRhdGE6IFJlc3BvbnNlIHwgc3RyaW5nKSB7XG5cdFx0XHRcdGlmIChkYXRhIGluc3RhbmNlb2YgUmVzcG9uc2UpIHtcblx0XHRcdFx0XHRpZiAoZGF0YS5zdGF0dXMgPj0gNDAwKSB7XG5cdFx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoZGF0YSlcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRkYXRhLmhlYWRlcnMuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG5cdFx0XHRcdFx0XHR0aGlzLnJhdy5zZXRIZWFkZXIoa2V5LCB2YWx1ZSlcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdHRoaXMucmF3LnN0YXR1c0NvZGUgPSBkYXRhLnN0YXR1c1xuXHRcdFx0XHRcdGRhdGEudGV4dCgpLnRoZW4oKHRleHQpID0+IHtcblx0XHRcdFx0XHRcdHRoaXMucmF3LmVuZCh0ZXh0KVxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhpcy5yYXcuZW5kKGRhdGEpXG5cdFx0XHRcdH1cblx0XHRcdFx0dGhpcy5oYXNTZW50ID0gdHJ1ZVxuXHRcdFx0XHRyZXR1cm4gdGhpc1xuXHRcdFx0fSxcblx0XHRcdGhlYWRlcjogZnVuY3Rpb24gKG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuXHRcdFx0XHR0aGlzLnJhdy5zZXRIZWFkZXIobmFtZSwgdmFsdWUpXG5cdFx0XHRcdHJldHVybiB0aGlzXG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Ly8gRmluZCBtYXRjaGluZyByb3V0ZSBhbmQgZXhlY3V0ZSBoYW5kbGVyXG5cdFx0bG9nZ2VyLmRlYnVnKGNvbG9yLmJvbGQocmVxLm1ldGhvZCksIHJlcS51cmwpXG5cdFx0Y29uc3Qgcm91dGUgPSByb3V0ZXIuZmluZChwYXJzZWRVcmwucGF0aG5hbWUpXG5cdFx0aWYgKHJvdXRlKSB7XG5cdFx0XHRhcHBseVBhcmFtcyhyZXF1ZXN0V3JhcHBlciwgcm91dGUucGFyYW1zKVxuXHRcdH1cblxuXHRcdC8vIElmIFZpdGUgaXMgYXZhaWxhYmxlLCBmb3J3YXJkIHRoZSByZXF1ZXN0IHRvIFZpdGVcblx0XHRpZiAoIXJvdXRlPy5oYW5kbGVyICYmIHZpdGUpIHtcblx0XHRcdGxvZ2dlci5kZWJ1ZyhgRm9yd2FyZGluZyB0byBWaXRlOmAsIHJlcS51cmwpXG5cdFx0XHR2aXRlLm1pZGRsZXdhcmVzKHJlcSwgcmVzKVxuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXG5cdFx0Ly8gSWYgcm91dGUgbWlzc2luZywgY2hlY2sgaWYgd2UgY2FuIHJldHVybiBzb21ldGhpbmcgZnJvbSB0aGUgcHVibGljIGZvbGRlclxuXHRcdGlmICghcm91dGU/LmhhbmRsZXIpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IGNhbGxiYWNrID0gYXN5bmMgKGZpbGVQYXRoOiBzdHJpbmcsIG1pbWVUeXBlOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRyZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBtaW1lVHlwZSlcblx0XHRcdFx0XHRyZXMuc2V0SGVhZGVyKCdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJywgJ25vc25pZmYnKVxuXHRcdFx0XHRcdHJlcy53cml0ZUhlYWQoMjAwKVxuXHRcdFx0XHRcdGF3YWl0IHBpcGVsaW5lKGNyZWF0ZVJlYWRTdHJlYW0oZmlsZVBhdGgpLCByZXMpXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoYXdhaXQgaGFuZGxlUHVibGljRmlsZShwYXJzZWRVcmwsIGNhbGxiYWNrKSkge1xuXHRcdFx0XHRcdHJldHVyblxuXHRcdFx0XHR9XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRpZiAoZXJyb3IgaW5zdGFuY2VvZiBSZXNwb25zZSkge1xuXHRcdFx0XHRcdHJlcGx5V3JhcHBlci5zZW5kKGVycm9yKVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGxvZ2dlci5lcnJvcihlcnJvcilcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmICghcm91dGU/LmhhbmRsZXIpIHtcblx0XHRcdHJlcGx5V3JhcHBlci5jb2RlKDQwNCkuanNvbignQVBJIFJvdXRlIG5vdCBmb3VuZC4nKVxuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJvdXRlLmhhbmRsZXIocmVxdWVzdFdyYXBwZXIsIHJlcGx5V3JhcHBlcilcblxuXHRcdFx0aWYgKCFyZXBseVdyYXBwZXIuaGFzU2VudCAmJiByZXN1bHQgaW5zdGFuY2VvZiBSZXNwb25zZSkge1xuXHRcdFx0XHRyZXBseVdyYXBwZXIuc2VuZChyZXN1bHQpXG5cdFx0XHR9IGVsc2UgaWYgKCFyZXBseVdyYXBwZXIuaGFzU2VudCAmJiByZXN1bHQpIHtcblx0XHRcdFx0cmVwbHlXcmFwcGVyLmNvZGUoMjAwKS5qc29uKHJlc3VsdClcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0aWYgKGVycm9yIGluc3RhbmNlb2YgUmVzcG9uc2UpIHtcblx0XHRcdFx0cmVwbHlXcmFwcGVyLnNlbmQoZXJyb3IpXG5cdFx0XHR9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKGVycm9yKVxuXHRcdFx0XHRyZXBseVdyYXBwZXIuY29kZSg1MDApLmpzb24oZXJyb3IubWVzc2FnZSA/PyAnU2VydmVyIGVuY291bnRlcmVkIGFuIGVycm9yLicpXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoZXJyb3IpXG5cdFx0XHRcdHJlcGx5V3JhcHBlci5jb2RlKDUwMCkuc2VuZCgnU2VydmVyIGVuY291bnRlcmVkIGFuIGVycm9yLicpXG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVQdWJsaWNGaWxlKFxuXHRwYXJzZWRVcmw6IFVybFdpdGhQYXJzZWRRdWVyeSxcblx0Y2FsbGJhY2s6IChmaWxlUGF0aDogc3RyaW5nLCBtaW1lVHlwZTogc3RyaW5nKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPlxuKSB7XG5cdC8vIERldGVybWluZSB3aGljaCBwdWJsaWMgZm9sZGVyIHRvIHVzZSAocHJvZHVjdGlvbiBvciBkZXZlbG9wbWVudClcblx0Y29uc3QgcHVibGljUGF0aCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicgPyBQdWJsaWNCdWlsZFBhdGggOiBQdWJsaWNQYXRoXG5cdGNvbnN0IGZpbGVQYXRoID0gZGVjb2RlVVJJKHBhdGguam9pbihwdWJsaWNQYXRoLCBwYXJzZWRVcmwucGF0aG5hbWUpKVxuXG5cdC8vIENoZWNrIGlmIHRoZSByZXF1ZXN0ZWQgcGF0aCBpcyB3aXRoaW4gdGhlIHB1YmxpYyBmb2xkZXIgdG8gZ3VhcmQgYWdhaW5zdCBkaXJlY3RvcnkgdHJhdmVyc2FsXG5cdGlmICghZmlsZVBhdGguc3RhcnRzV2l0aChwdWJsaWNQYXRoKSkge1xuXHRcdGxvZ2dlci53YXJuKGBSZXF1ZXN0ZWQgcGF0aCBpcyBvdXRzaWRlIHRoZSBwdWJsaWMgZm9sZGVyLiBEZW55aW5nIGFjY2Vzcy4uLmApXG5cdFx0dGhyb3cgUm9ib1Jlc3BvbnNlLmpzb24oXG5cdFx0XHR7XG5cdFx0XHRcdG1lc3NhZ2U6ICdBY2Nlc3MgRGVuaWVkJ1xuXHRcdFx0fSxcblx0XHRcdHtcblx0XHRcdFx0c3RhdHVzOiA0MDNcblx0XHRcdH1cblx0XHQpXG5cdH1cblxuXHQvLyBTZWUgaWYgdGhlIGZpbGUgZXhpc3RzXG5cdHRyeSB7XG5cdFx0Y29uc3Qgc3RhdHMgPSBhd2FpdCBzdGF0KGZpbGVQYXRoKVxuXG5cdFx0aWYgKHN0YXRzLmlzRmlsZSgpKSB7XG5cdFx0XHRsb2dnZXIuZGVidWcoYFNlcnZpbmcgcHVibGljIGZpbGU6ICR7ZmlsZVBhdGh9YClcblx0XHRcdGNvbnN0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCkuc2xpY2UoMSlcblx0XHRcdGNvbnN0IG1pbWVUeXBlID0gbWltZURiW2V4dF0gPz8gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSdcblx0XHRcdGF3YWl0IGNhbGxiYWNrKGZpbGVQYXRoLCBtaW1lVHlwZSlcblx0XHRcdHJldHVybiB0cnVlXG5cdFx0fSBlbHNlIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG5cdFx0XHQvLyBMb29rIGZvciBhbiBpbmRleCBmaWxlIGluIHRoZSBkaXJlY3Rvcnlcblx0XHRcdGNvbnN0IGZpbGVzID0gYXdhaXQgcmVhZGRpcihmaWxlUGF0aClcblx0XHRcdGNvbnN0IGluZGV4RXh0ZW5zaW9ucyA9IFsnaHRtbCcsICdodG0nLCAncGhwJywgJ2pzJywgJ2pzb24nXVxuXHRcdFx0Y29uc3QgaW5kZXhGaWxlID0gZmlsZXMuZmluZCgoZmlsZSkgPT4ge1xuXHRcdFx0XHRjb25zdCBleHRlbnNpb24gPSBwYXRoLmV4dG5hbWUoZmlsZSkuc2xpY2UoMSlcblx0XHRcdFx0cmV0dXJuIGluZGV4RXh0ZW5zaW9ucy5pbmNsdWRlcyhleHRlbnNpb24pICYmIGZpbGUuc3RhcnRzV2l0aCgnaW5kZXguJylcblx0XHRcdH0pXG5cblx0XHRcdGlmIChpbmRleEZpbGUpIHtcblx0XHRcdFx0Y29uc3QgaW5kZXhGaWxlUGF0aCA9IHBhdGguam9pbihmaWxlUGF0aCwgaW5kZXhGaWxlKVxuXHRcdFx0XHRjb25zdCBleHQgPSBwYXRoLmV4dG5hbWUoaW5kZXhGaWxlUGF0aCkuc2xpY2UoMSlcblx0XHRcdFx0Y29uc3QgbWltZVR5cGUgPSBtaW1lRGJbZXh0XSA/PyAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJ1xuXHRcdFx0XHRsb2dnZXIuZGVidWcoJ1NlcnZpbmcgcHVibGljIGluZGV4IGZpbGU6JywgaW5kZXhGaWxlUGF0aClcblx0XHRcdFx0YXdhaXQgY2FsbGJhY2soaW5kZXhGaWxlUGF0aCwgbWltZVR5cGUpXG5cdFx0XHRcdHJldHVybiB0cnVlXG5cdFx0XHR9XG5cdFx0fVxuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdC8vIElnbm9yZSBFTk9FTlQgZXJyb3JzIChmaWxlIG5vdCBmb3VuZClcblx0XHRpZiAoZXJyb3IuY29kZSAhPT0gJ0VOT0VOVCcpIHtcblx0XHRcdHRocm93IGVycm9yXG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGZhbHNlXG59XG4iXSwibmFtZXMiOlsiUm9ib1JlcXVlc3QiLCJhcHBseVBhcmFtcyIsIlJvYm9SZXNwb25zZSIsImxvZ2dlciIsInBsdWdpbk9wdGlvbnMiLCJtaW1lRGIiLCJjcmVhdGVSZWFkU3RyZWFtIiwicmVhZGRpciIsInN0YXQiLCJwYXRoIiwicGlwZWxpbmUiLCJ1cmwiLCJjb2xvciIsIlB1YmxpY1BhdGgiLCJqb2luIiwicHJvY2VzcyIsImN3ZCIsIlB1YmxpY0J1aWxkUGF0aCIsImNyZWF0ZVNlcnZlckhhbmRsZXIiLCJyb3V0ZXIiLCJ2aXRlIiwicmVxIiwicmVzIiwicGFyc2VkVXJsIiwicGFyc2UiLCJjb3JzIiwic2V0SGVhZGVyIiwibWV0aG9kIiwid3JpdGVIZWFkIiwiZW5kIiwicmVxdWVzdFdyYXBwZXIiLCJmcm9tIiwicmVwbHlXcmFwcGVyIiwicmF3IiwiaGFzU2VudCIsImNvZGUiLCJzdGF0dXNDb2RlIiwianNvbiIsImRhdGEiLCJKU09OIiwic3RyaW5naWZ5Iiwic2VuZCIsIlJlc3BvbnNlIiwic3RhdHVzIiwiZXJyb3IiLCJoZWFkZXJzIiwiZm9yRWFjaCIsImtleSIsInZhbHVlIiwidGV4dCIsInRoZW4iLCJoZWFkZXIiLCJuYW1lIiwiZGVidWciLCJib2xkIiwicm91dGUiLCJmaW5kIiwicGF0aG5hbWUiLCJwYXJhbXMiLCJoYW5kbGVyIiwibWlkZGxld2FyZXMiLCJjYWxsYmFjayIsImZpbGVQYXRoIiwibWltZVR5cGUiLCJoYW5kbGVQdWJsaWNGaWxlIiwicmVzdWx0IiwiRXJyb3IiLCJtZXNzYWdlIiwicHVibGljUGF0aCIsImVudiIsIk5PREVfRU5WIiwiZGVjb2RlVVJJIiwic3RhcnRzV2l0aCIsIndhcm4iLCJzdGF0cyIsImlzRmlsZSIsImV4dCIsImV4dG5hbWUiLCJzbGljZSIsImlzRGlyZWN0b3J5IiwiZmlsZXMiLCJpbmRleEV4dGVuc2lvbnMiLCJpbmRleEZpbGUiLCJmaWxlIiwiZXh0ZW5zaW9uIiwiaW5jbHVkZXMiLCJpbmRleEZpbGVQYXRoIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxXQUFXLEVBQUVDLFdBQVcsUUFBUSxvQkFBbUI7QUFDNUQsU0FBU0MsWUFBWSxRQUFRLHFCQUFvQjtBQUNqRCxTQUFTQyxNQUFNLFFBQVEsY0FBYTtBQUNwQyxTQUFTQyxhQUFhLFFBQVEsc0JBQXFCO0FBQ25ELFNBQVNDLE1BQU0sUUFBUSxZQUFXO0FBQ2xDLFNBQVNDLGdCQUFnQixRQUFRLFVBQVM7QUFDMUMsU0FBU0MsT0FBTyxFQUFFQyxJQUFJLFFBQVEsbUJBQWtCO0FBRWhELE9BQU9DLFVBQVUsWUFBVztBQUM1QixTQUFTQyxRQUFRLFFBQVEsdUJBQXNCO0FBQy9DLE9BQU9DLFNBQVMsV0FBVTtBQUMxQixTQUFTQyxLQUFLLFFBQVEsVUFBUztBQU0vQixNQUFN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