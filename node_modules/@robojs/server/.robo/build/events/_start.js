import { logger } from "../core/logger.js";
import { hasDependency } from "../core/runtime-utils.js";
import { _readyPromiseResolve } from "../../../.robo/build/core/plugin-utils.js";
import { existsSync } from "node:fs";
import path from "node:path";
import { portal } from "robo.js";
const PATH_REGEX = new RegExp(/\[(.+?)\]/g);
export let pluginOptions = {};
export default (async (_client, options)=>{
    pluginOptions = options ?? {};
    // Set default options
    if (pluginOptions.prefix === undefined) {
        pluginOptions.prefix = '/api';
    }
    if (!pluginOptions.engine) {
        pluginOptions.engine = await getDefaultEngine();
    }
    // Start HTTP server only if API Routes are defined
    const { engine , port =parseInt(process.env.PORT ?? '3000')  } = pluginOptions;
    let vite = pluginOptions.vite;
    logger.debug(`Preparing server with ${portal.apis.size} API routes...`);
    await engine.init({
        vite
    });
    // If Vite is available, start the dev server
    if (vite) {
        logger.debug('Using Vite server specified in options.');
    } else if (process.env.NODE_ENV !== 'production' && await hasDependency('vite', true)) {
        try {
            const { createServer: createViteServer  } = await import("vite");
            const viteConfigPath = path.join(process.cwd(), 'config', 'vite.mjs');
            vite = await createViteServer({
                configFile: existsSync(viteConfigPath) ? viteConfigPath : undefined,
                server: {
                    hmr: {
                        path: '/hmr',
                        server: engine.getHttpServer()
                    },
                    middlewareMode: {
                        server: engine.getHttpServer()
                    }
                }
            });
            logger.debug('Vite server created successfully.');
        } catch (e) {
            logger.error(`Failed to start Vite server:`, e);
        }
    }
    // Setup Vite if available and register socket bypass
    if (vite) {
        await engine.setupVite(vite);
        // Prevent other plugins from registering the HMR route
        engine.registerWebsocket('/hmr', ()=>{
            logger.debug('Vite HMR connection detected. Skipping registration...');
        });
    }
    // Add loaded API modules onto new router instance
    const prefix = pluginOptions.prefix ?? '';
    const paths = [];
    portal.apis.forEach((api)=>{
        const key = prefix + '/' + api.key.replace(PATH_REGEX, ':$1');
        paths.push(key);
        // @ts-expect-error - Outdated Robo API typings
        engine.registerRoute(key, api.handler.default);
    });
    logger.debug(`Starting server...`);
    await engine.start({
        port
    });
    _readyPromiseResolve();
});
async function getDefaultEngine() {
    // Return Fastify if available
    const isFastifyAvailable = await hasDependency('fastify');
    if (isFastifyAvailable) {
        logger.debug('Fastify is available. Using it as the server engine.');
        const { FastifyEngine  } = await import("../engines/fastify.js");
        return new FastifyEngine();
    }
    // Default engine
    logger.debug('Using Node.js as the server engine.');
    const { NodeEngine  } = await import("../engines/node.js");
    return new NodeEngine();
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3JvYm8uanMvcm9iby5qcy9wYWNrYWdlcy9wbHVnaW4tYXBpL3NyYy9ldmVudHMvX3N0YXJ0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2VyLmpzJ1xuaW1wb3J0IHsgaGFzRGVwZW5kZW5jeSB9IGZyb20gJy4uL2NvcmUvcnVudGltZS11dGlscy5qcydcbmltcG9ydCB7IF9yZWFkeVByb21pc2VSZXNvbHZlIH0gZnJvbSAnfi9jb3JlL3BsdWdpbi11dGlscy5qcydcbmltcG9ydCB7IGV4aXN0c1N5bmMgfSBmcm9tICdub2RlOmZzJ1xuaW1wb3J0IHBhdGggZnJvbSAnbm9kZTpwYXRoJ1xuaW1wb3J0IHsgcG9ydGFsIH0gZnJvbSAncm9iby5qcydcbmltcG9ydCB0eXBlIHsgQmFzZUVuZ2luZSB9IGZyb20gJy4uL2VuZ2luZXMvYmFzZS5qcydcbmltcG9ydCB0eXBlIHsgQ2xpZW50IH0gZnJvbSAnZGlzY29yZC5qcydcbmltcG9ydCB0eXBlIHsgVml0ZURldlNlcnZlciB9IGZyb20gJ3ZpdGUnXG5cbmNvbnN0IFBBVEhfUkVHRVggPSBuZXcgUmVnRXhwKC9cXFsoLis/KVxcXS9nKVxuXG5pbnRlcmZhY2UgUGx1Z2luT3B0aW9ucyB7XG5cdGNvcnM/OiBib29sZWFuXG5cdGVuZ2luZT86IEJhc2VFbmdpbmVcblx0cG9ydD86IG51bWJlclxuXHRwcmVmaXg/OiBzdHJpbmcgfCBudWxsIHwgZmFsc2Vcblx0dml0ZT86IFZpdGVEZXZTZXJ2ZXJcbn1cblxuZXhwb3J0IGxldCBwbHVnaW5PcHRpb25zOiBQbHVnaW5PcHRpb25zID0ge31cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKF9jbGllbnQ6IENsaWVudCwgb3B0aW9uczogUGx1Z2luT3B0aW9ucykgPT4ge1xuXHRwbHVnaW5PcHRpb25zID0gb3B0aW9ucyA/PyB7fVxuXG5cdC8vIFNldCBkZWZhdWx0IG9wdGlvbnNcblx0aWYgKHBsdWdpbk9wdGlvbnMucHJlZml4ID09PSB1bmRlZmluZWQpIHtcblx0XHRwbHVnaW5PcHRpb25zLnByZWZpeCA9ICcvYXBpJ1xuXHR9XG5cdGlmICghcGx1Z2luT3B0aW9ucy5lbmdpbmUpIHtcblx0XHRwbHVnaW5PcHRpb25zLmVuZ2luZSA9IGF3YWl0IGdldERlZmF1bHRFbmdpbmUoKVxuXHR9XG5cblx0Ly8gU3RhcnQgSFRUUCBzZXJ2ZXIgb25seSBpZiBBUEkgUm91dGVzIGFyZSBkZWZpbmVkXG5cdGNvbnN0IHsgZW5naW5lLCBwb3J0ID0gcGFyc2VJbnQocHJvY2Vzcy5lbnYuUE9SVCA/PyAnMzAwMCcpIH0gPSBwbHVnaW5PcHRpb25zXG5cdGxldCB2aXRlOiBWaXRlRGV2U2VydmVyIHwgdW5kZWZpbmVkID0gcGx1Z2luT3B0aW9ucy52aXRlXG5cblx0bG9nZ2VyLmRlYnVnKGBQcmVwYXJpbmcgc2VydmVyIHdpdGggJHtwb3J0YWwuYXBpcy5zaXplfSBBUEkgcm91dGVzLi4uYClcblx0YXdhaXQgZW5naW5lLmluaXQoeyB2aXRlIH0pXG5cblx0Ly8gSWYgVml0ZSBpcyBhdmFpbGFibGUsIHN0YXJ0IHRoZSBkZXYgc2VydmVyXG5cdGlmICh2aXRlKSB7XG5cdFx0bG9nZ2VyLmRlYnVnKCdVc2luZyBWaXRlIHNlcnZlciBzcGVjaWZpZWQgaW4gb3B0aW9ucy4nKVxuXHR9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgKGF3YWl0IGhhc0RlcGVuZGVuY3koJ3ZpdGUnLCB0cnVlKSkpIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgeyBjcmVhdGVTZXJ2ZXI6IGNyZWF0ZVZpdGVTZXJ2ZXIgfSA9IGF3YWl0IGltcG9ydCgndml0ZScpXG5cdFx0XHRjb25zdCB2aXRlQ29uZmlnUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnY29uZmlnJywgJ3ZpdGUubWpzJylcblxuXHRcdFx0dml0ZSA9IGF3YWl0IGNyZWF0ZVZpdGVTZXJ2ZXIoe1xuXHRcdFx0XHRjb25maWdGaWxlOiBleGlzdHNTeW5jKHZpdGVDb25maWdQYXRoKSA/IHZpdGVDb25maWdQYXRoIDogdW5kZWZpbmVkLFxuXHRcdFx0XHRzZXJ2ZXI6IHtcblx0XHRcdFx0XHRobXI6IHsgcGF0aDogJy9obXInLCBzZXJ2ZXI6IGVuZ2luZS5nZXRIdHRwU2VydmVyKCkgfSxcblx0XHRcdFx0XHRtaWRkbGV3YXJlTW9kZTogeyBzZXJ2ZXI6IGVuZ2luZS5nZXRIdHRwU2VydmVyKCkgfVxuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHRcdFx0bG9nZ2VyLmRlYnVnKCdWaXRlIHNlcnZlciBjcmVhdGVkIHN1Y2Nlc3NmdWxseS4nKVxuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHN0YXJ0IFZpdGUgc2VydmVyOmAsIGUpXG5cdFx0fVxuXHR9XG5cblx0Ly8gU2V0dXAgVml0ZSBpZiBhdmFpbGFibGUgYW5kIHJlZ2lzdGVyIHNvY2tldCBieXBhc3Ncblx0aWYgKHZpdGUpIHtcblx0XHRhd2FpdCBlbmdpbmUuc2V0dXBWaXRlKHZpdGUpXG5cblx0XHQvLyBQcmV2ZW50IG90aGVyIHBsdWdpbnMgZnJvbSByZWdpc3RlcmluZyB0aGUgSE1SIHJvdXRlXG5cdFx0ZW5naW5lLnJlZ2lzdGVyV2Vic29ja2V0KCcvaG1yJywgKCkgPT4ge1xuXHRcdFx0bG9nZ2VyLmRlYnVnKCdWaXRlIEhNUiBjb25uZWN0aW9uIGRldGVjdGVkLiBTa2lwcGluZyByZWdpc3RyYXRpb24uLi4nKVxuXHRcdH0pXG5cdH1cblxuXHQvLyBBZGQgbG9hZGVkIEFQSSBtb2R1bGVzIG9udG8gbmV3IHJvdXRlciBpbnN0YW5jZVxuXHRjb25zdCBwcmVmaXggPSBwbHVnaW5PcHRpb25zLnByZWZpeCA/PyAnJ1xuXHRjb25zdCBwYXRoczogc3RyaW5nW10gPSBbXVxuXG5cdHBvcnRhbC5hcGlzLmZvckVhY2goKGFwaSkgPT4ge1xuXHRcdGNvbnN0IGtleSA9IHByZWZpeCArICcvJyArIGFwaS5rZXkucmVwbGFjZShQQVRIX1JFR0VYLCAnOiQxJylcblx0XHRwYXRocy5wdXNoKGtleSlcblx0XHQvLyBAdHMtZXhwZWN0LWVycm9yIC0gT3V0ZGF0ZWQgUm9ibyBBUEkgdHlwaW5nc1xuXHRcdGVuZ2luZS5yZWdpc3RlclJvdXRlKGtleSwgYXBpLmhhbmRsZXIuZGVmYXVsdClcblx0fSlcblxuXHRsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHNlcnZlci4uLmApXG5cdGF3YWl0IGVuZ2luZS5zdGFydCh7IHBvcnQgfSlcblx0X3JlYWR5UHJvbWlzZVJlc29sdmUoKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZWZhdWx0RW5naW5lKCkge1xuXHQvLyBSZXR1cm4gRmFzdGlmeSBpZiBhdmFpbGFibGVcblx0Y29uc3QgaXNGYXN0aWZ5QXZhaWxhYmxlID0gYXdhaXQgaGFzRGVwZW5kZW5jeSgnZmFzdGlmeScpXG5cdGlmIChpc0Zhc3RpZnlBdmFpbGFibGUpIHtcblx0XHRsb2dnZXIuZGVidWcoJ0Zhc3RpZnkgaXMgYXZhaWxhYmxlLiBVc2luZyBpdCBhcyB0aGUgc2VydmVyIGVuZ2luZS4nKVxuXHRcdGNvbnN0IHsgRmFzdGlmeUVuZ2luZSB9ID0gYXdhaXQgaW1wb3J0KCcuLi9lbmdpbmVzL2Zhc3RpZnkuanMnKVxuXHRcdHJldHVybiBuZXcgRmFzdGlmeUVuZ2luZSgpXG5cdH1cblxuXHQvLyBEZWZhdWx0IGVuZ2luZVxuXHRsb2dnZXIuZGVidWcoJ1VzaW5nIE5vZGUuanMgYXMgdGhlIHNlcnZlciBlbmdpbmUuJylcblx0Y29uc3QgeyBOb2RlRW5naW5lIH0gPSBhd2FpdCBpbXBvcnQoJy4uL2VuZ2luZXMvbm9kZS5qcycpXG5cdHJldHVybiBuZXcgTm9kZUVuZ2luZSgpXG59XG4iXSwibmFtZXMiOlsibG9nZ2VyIiwiaGFzRGVwZW5kZW5jeSIsIl9yZWFkeVByb21pc2VSZXNvbHZlIiwiZXhpc3RzU3luYyIsInBhdGgiLCJwb3J0YWwiLCJQQVRIX1JFR0VYIiwiUmVnRXhwIiwicGx1Z2luT3B0aW9ucyIsIl9jbGllbnQiLCJvcHRpb25zIiwicHJlZml4IiwidW5kZWZpbmVkIiwiZW5naW5lIiwiZ2V0RGVmYXVsdEVuZ2luZSIsInBvcnQiLCJwYXJzZUludCIsInByb2Nlc3MiLCJlbnYiLCJQT1JUIiwidml0ZSIsImRlYnVnIiwiYXBpcyIsInNpemUiLCJpbml0IiwiTk9ERV9FTlYiLCJjcmVhdGVTZXJ2ZXIiLCJjcmVhdGVWaXRlU2VydmVyIiwidml0ZUNvbmZpZ1BhdGgiLCJqb2luIiwiY3dkIiwiY29uZmlnRmlsZSIsInNlcnZlciIsImhtciIsImdldEh0dHBTZXJ2ZXIiLCJtaWRkbGV3YXJlTW9kZSIsImUiLCJlcnJvciIsInNldHVwVml0ZSIsInJlZ2lzdGVyV2Vic29ja2V0IiwicGF0aHMiLCJmb3JFYWNoIiwiYXBpIiwia2V5IiwicmVwbGFjZSIsInB1c2giLCJyZWdpc3RlclJvdXRlIiwiaGFuZGxlciIsImRlZmF1bHQiLCJzdGFydCIsImlzRmFzdGlmeUF2YWlsYWJsZSIsIkZhc3RpZnlFbmdpbmUiLCJOb2RlRW5naW5lIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxNQUFNLFFBQVEsb0JBQW1CO0FBQzFDLFNBQVNDLGFBQWEsUUFBUSwyQkFBMEI7QUFDeEQsU0FBU0Msb0JBQW9CLFFBQVEsNENBQXdCO0FBQzdELFNBQVNDLFVBQVUsUUFBUSxVQUFTO0FBQ3BDLE9BQU9DLFVBQVUsWUFBVztBQUM1QixTQUFTQyxNQUFNLFFBQVEsVUFBUztBQUtoQyxNQUFNQyxhQUFhLElBQUlDLE9BQU87QUFVOUIsT0FBTyxJQUFJQyxnQkFBK0IsQ0FBQyxFQUFDO0FBRTVDLGVBQWUsQ0FBQSxPQUFPQyxTQUFpQkMsVUFBMkI7SUFDakVGLGdCQUFnQkUsV0FBVyxDQUFDO0lBRTVCLHNCQUFzQjtJQUN0QixJQUFJRixjQUFjRyxNQUFNLEtBQUtDLFdBQVc7UUFDdkNKLGNBQWNHLE1BQU0sR0FBRztJQUN4QixDQUFDO0lBQ0QsSUFBSSxDQUFDSCxjQUFjSyxNQUFNLEVBQUU7UUFDMUJMLGNBQWNL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